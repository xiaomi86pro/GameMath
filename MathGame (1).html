<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Math - ·ª®ng D·ª•ng H·ªçc To√°n T∆∞∆°ng T√°c</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Tone.js cho hi·ªáu ·ª©ng √¢m thanh -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* T√πy ch·ªânh font cho d·ªÖ nh√¨n h∆°n */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 90%;
            width: 800px;
        }
        .math-input {
            width: 120px;
            text-align: center;
            font-size: 1.5rem;
        }
        .sorting-number {
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            user-select: none;
        }
        .sorting-number:hover:not(.selected) {
            background-color: #d1e5ff;
        }
        .selected {
            border: 3px solid #10b981;
            transform: scale(1.05);
        }
        
        /* C·∫≠p nh·∫≠t CSS cho ƒë·ªô t∆∞∆°ng ph·∫£n cao h∆°n: N·ªÅn nh·∫°t, Ch·ªØ ƒë·∫≠m */
        .correct-answer-box {
            background-color: #d1fae5 !important; /* light green (green-100) */
            animation: pulse-green 0.5s;
        }
        .incorrect-answer-box {
            background-color: #fee2e2 !important; /* light red (red-100) */
            animation: pulse-red 0.5s;
        }
        /* C·∫≠p nh·∫≠t CSS cho h·ªôp th√¥ng b√°o l·ªói/ch∆∞a nh·∫≠p ƒë√°p √°n (v√†ng) */
        .warning-answer-box {
            background-color: #fef9c3 !important; /* light yellow (yellow-100) */
        }


        /* --- Score Pop-up Effect --- */
        .score-effect {
            position: absolute;
            top: 0px; /* V·ªã tr√≠ ban ƒë·∫ßu */
            right: 0px;
            font-size: 1.5rem;
            font-weight: 800;
            opacity: 0;
            transition: all 0.5s ease-out;
            pointer-events: none;
        }
        .score-container-relative {
            position: relative;
        }
        
        /* D√πng keyframes cho c√°c hi·ªáu ·ª©ng n·ªÅn */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Styling cho ƒë·ªìng h·ªì kim SVG */
        .clock-face {
            fill: #f9fafb;
            stroke: #374151;
            stroke-width: 4;
        }
        .hour-hand {
            stroke: #1f2937;
            stroke-linecap: round;
            stroke-width: 6;
            transform-origin: 50% 50%;
        }
        .minute-hand {
            stroke: #ef4444;
            stroke-linecap: round;
            stroke-width: 4;
            transform-origin: 50% 50%;
        }

        /* Styling ƒë·∫∑c bi·ªát cho √¥ so s√°nh */
        .comparison-box {
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="p-4">

    <div class="container bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-6">üß† ·ª®ng D·ª•ng H·ªçc To√°n T∆∞∆°ng T√°c</h1>
        
        <div id="setup-screen" class="space-y-6">
            <p class="text-lg text-gray-600 text-center">Ch·ªçn c·∫•p ƒë·ªô ƒë·ªÉ b·∫Øt ƒë·∫ßu b√†i quiz 20 c√¢u ng·∫´u nhi√™n. Quiz k√©o d√†i 30 ph√∫t.</p>

            <!-- CH·ªåN C·∫§P ƒê·ªò: C·ªòNG TR·ª™ -->
            <div class="p-4 bg-indigo-50 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-indigo-800 mb-3">C·ªông Tr·ª´ (Addition/Subtraction):</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button class="level-select-btn p-3 rounded-lg font-bold text-lg transition duration-150 hover:bg-indigo-600 hover:text-white bg-gray-200 text-gray-700 shadow-md" data-level="1" data-type="ADD_SUB" data-name="C·∫•p 1 (Ph·∫°m vi 0-9)">C·∫•p 1 (0-9)</button>
                    <button class="level-select-btn p-3 rounded-lg font-bold text-lg transition duration-150 hover:bg-indigo-600 hover:text-white bg-gray-200 text-gray-700 shadow-md" data-level="2" data-type="ADD_SUB" data-name="C·∫•p 2 (Ph·∫°m vi 0-99)">C·∫•p 2 (0-99)</button>
                    <button class="level-select-btn p-3 rounded-lg font-bold text-lg transition duration-150 hover:bg-indigo-600 hover:text-white bg-gray-200 text-gray-700 shadow-md" data-level="3" data-type="ADD_SUB" data-name="C·∫•p 3 (Ph·∫°m vi 0-999)">C·∫•p 3 (0-999)</button>
                </div>
            </div>

            <!-- CH·ªåN C·∫§P ƒê·ªò: NH√ÇN CHIA -->
            <div class="p-4 bg-green-50 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-green-800 mb-3">Nh√¢n Chia (Multiplication/Division):</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button class="level-select-btn p-3 rounded-lg font-bold text-lg transition duration-150 hover:bg-green-600 hover:text-white bg-gray-200 text-gray-700 shadow-md" data-level="1" data-type="MULT_DIV" data-name="C·∫•p 1 (B·∫£ng x2, x3)">C·∫•p 1 (x2, x3)</button>
                    <button class="level-select-btn p-3 rounded-lg font-bold text-lg transition duration-150 hover:bg-green-600 hover:text-white bg-gray-200 text-gray-700 shadow-md" data-level="2" data-type="MULT_DIV" data-name="C·∫•p 2 (B·∫£ng x4, x5)">C·∫•p 2 (x4, x5)</button>
                    <button class="level-select-btn p-3 rounded-lg font-bold text-lg transition duration-150 hover:bg-green-600 hover:text-white bg-gray-200 text-gray-700 shadow-md" data-level="3" data-type="MULT_DIV" data-name="C·∫•p 3 (B·∫£ng x6, x7)">C·∫•p 3 (x6, x7)</button>
                    <button class="level-select-btn p-3 rounded-lg font-bold text-lg transition duration-150 hover:bg-green-600 hover:text-white bg-gray-200 text-gray-700 shadow-md" data-level="4" data-type="MULT_DIV" data-name="C·∫•p 4 (B·∫£ng x8, x9)">C·∫•p 4 (x8, x9)</button>
                </div>
            </div>

            <p id="level-description" class="mt-4 text-sm text-indigo-700 text-center font-medium">B·∫°n ƒë√£ ch·ªçn: C·∫•p 1 (Ph·∫°m vi s·ªë t·ª´ 0 ƒë·∫øn 9).</p>
<!-- Ch·ªçn s·ªë c√¢u h·ªèi -->
<div class="text-center mt-4">
    <p class="text-md font-semibold text-gray-700 mb-2">Ch·ªçn s·ªë c√¢u h·ªèi:</p>
    <div id="question-count-options" class="flex justify-center space-x-4">
        <button data-questions="10" class="q-count-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-indigo-500 hover:text-white transition">
            10 c√¢u
        </button>
        <button data-questions="20" class="q-count-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-indigo-500 hover:text-white transition">
            20 c√¢u
        </button>
        <button data-questions="30" class="q-count-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-indigo-500 hover:text-white transition">
            30 c√¢u
        </button>
    </div>
</div>

            <div class="text-center pt-4">
                <button id="start-quiz-btn" class="px-8 py-3 bg-red-600 text-white text-xl font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105" disabled>
                    B·∫Øt ƒê·∫ßu Quiz
                </button>
            </div>
        </div>

        <!-- M√†n H√¨nh Quiz -->
        <div id="quiz-screen" class="hidden text-center">
            
            <!-- Header Bar -->
            <div class="mb-6 flex justify-between items-center text-gray-600">
                <button id="exit-quiz-btn" class="px-4 py-2 bg-red-100 text-red-600 font-semibold rounded-lg hover:bg-red-200 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    Quay l·∫°i M√†n h√¨nh Ch√≠nh
                </button>
                
                <!-- Timer -->
                <p class="text-xl font-semibold text-red-600">
                    ‚è∞ <span id="quiz-timer" class="font-extrabold text-3xl">30:00</span>
                </p>

                <!-- Score Container with Relative Positioning for Effect -->
                <p class="text-xl font-semibold score-container-relative">
                    ƒêi·ªÉm: <span id="current-score" class="text-green-600 font-extrabold text-2xl">0</span>
                    <span id="score-effect" class="score-effect"></span>
                </p>
            </div>
            
            <!-- Progress Bar -->
            <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner">
                <div id="progress-bar" class="bg-indigo-500 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
            
            <p class="text-lg font-semibold mb-4">C·∫•p ƒë·ªô: <span id="current-level-name">C·∫•p 1</span> | C√¢u h·ªèi: <span id="current-question-number">0</span> / <span id="total-questions">20</span></p>


            <!-- Khu v·ª±c c√¢u h·ªèi -->
            <div id="question-area" class="min-h-[150px] flex flex-col justify-center items-center p-6 bg-blue-100 rounded-xl shadow-xl mb-6">
                <!-- V√πng cho h√¨nh ·∫£nh ƒë·ªìng h·ªì (Q19) -->
                <div id="clock-image-container" class="hidden my-4">
                    <!-- SVG clock will be generated here -->
                </div>
                
                <!-- D·∫°ng b√†i so s√°nh -->
                <div id="comparison-display-area" class="hidden w-full flex flex-col md:flex-row justify-center items-center space-x-0 md:space-x-4">
                    <p id="expression-left" class="text-4xl md:text-5xl font-extrabold text-blue-800 p-2"></p>
                    <div id="comparison-box" class="comparison-box w-16 h-16 md:w-20 md:h-20 border-4 border-indigo-400 rounded-lg bg-white shadow-inner text-4xl font-extrabold text-red-600 my-4 md:my-0">?</div>
                    <p id="expression-right" class="text-4xl md:text-5xl font-extrabold text-blue-800 p-2"></p>
                </div>

                <!-- D·∫°ng b√†i th√¥ng th∆∞·ªùng (k·ªÉ c·∫£ b√†i to√°n l·ªùi vƒÉn) -->
                <p id="question-text" class="text-xl md:text-3xl font-extrabold text-blue-800">C√¢u h·ªèi s·∫Ω hi·ªán ·ªü ƒë√¢y...</p>
            </div>

            <!-- Khu v·ª±c tr·∫£ l·ªùi -->
            <div id="answer-area" class="flex flex-col items-center space-y-4">
                <!-- V√πng cho B√†i t·∫≠p C·ªông/Tr·ª´, T√¨m X, L·ªùi VƒÉn, ƒê·ªçc Gi·ªù -->
                <div id="input-answer-container" class="flex items-center space-x-3 hidden">
                    <input type="number" id="math-answer-input" placeholder="Nh·∫≠p ƒë√°p √°n" class="math-input p-3 border-2 border-indigo-300 rounded-lg focus:ring-4 focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="submit-answer-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-300">Ki·ªÉm tra</button>
                </div>
                
                <!-- V√πng cho B√†i t·∫≠p So s√°nh (n√∫t b·∫•m) -->
                <div id="comparison-buttons-container" class="space-x-4 hidden">
                    <button data-op=">" class="comp-btn px-8 py-4 bg-indigo-600 text-white text-3xl font-bold rounded-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 shadow-lg active:bg-indigo-800">></button>
                    <button data-op="<" class="comp-btn px-8 py-4 bg-indigo-600 text-white text-3xl font-bold rounded-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 shadow-lg active:bg-indigo-800"><</button>
                    <button data-op="=" class="comp-btn px-8 py-4 bg-indigo-600 text-white text-3xl font-bold rounded-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 shadow-lg active:bg-indigo-800">=</button>
                </div>

                <!-- V√πng cho B√†i t·∫≠p S·∫Øp x·∫øp -->
                <div id="sorting-numbers-container" class="flex flex-wrap justify-center gap-3 hidden">
                    <!-- C√°c √¥ s·ªë s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                </div>
                <div id="sorting-target-container" class="flex flex-wrap justify-center gap-3 p-4 bg-gray-200 rounded-lg w-full max-w-md min-h-[70px] hidden">
                    <!-- C√°c √¥ s·ªë ƒë√£ ch·ªçn s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                </div>
                <div id="sorting-controls" class="space-x-4 hidden">
                    <button id="reset-sorting-btn" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-300">ƒê·∫∑t l·∫°i</button>
                    <button id="submit-sorting-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-300">Ho√†n th√†nh</button>
                </div>
            </div>

            <!-- Message Box -->
            <p id="message-box" class="mt-4 text-xl font-bold min-h-[30px]"></p>

            <button id="next-question-btn" class="mt-6 px-6 py-3 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition duration-300 hidden">C√¢u h·ªèi ti·∫øp theo</button>
        </div>
        
        <!-- M√†n H√¨nh K·∫øt th√∫c Quiz -->
        <div id="end-screen" class="hidden text-center p-8 bg-white rounded-xl shadow-2xl">
            <h2 class="text-4xl font-extrabold text-green-700 mb-4">Ho√†n th√†nh Quiz! üéâ</h2>
            <p class="text-2xl text-gray-700 mb-6">B·∫°n ƒë√£ ho√†n th√†nh 20 c√¢u h·ªèi.</p>
            <p class="text-5xl font-extrabold text-indigo-600">ƒêi·ªÉm c·ªßa b·∫°n: <span id="final-score">0</span> / 20</p>
            <p id="time-taken-message" class="text-xl text-gray-600 mt-4"></p>
            <button id="restart-quiz-btn" class="mt-8 px-8 py-3 bg-red-600 text-white text-xl font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105">
                Ch∆°i l·∫°i
            </button>
        </div>

        <!-- Custom Modal for Confirmation (using Tailwind) -->
        <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-4">
                <h3 class="text-xl font-bold text-red-600 mb-4">X√°c nh·∫≠n Quay l·∫°i</h3>
                <p class="text-gray-700 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën quay l·∫°i m√†n h√¨nh ch√≠nh? M·ªçi ti·∫øn tr√¨nh quiz hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t.</p>
                <div class="flex justify-end space-x-4">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">H·ªßy</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Quay l·∫°i</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Constants
        
        // Lo·∫°i c√¢u h·ªèi: C·ªông/Tr·ª´/So s√°nh/S·∫Øp x·∫øp/T√¨m X, Nh√¢n/Chia, ƒê·ªçc gi·ªù, B√†i to√°n l·ªùi vƒÉn
        const QUESTION_TYPES_BASIC = ['basic-op', 'find-x', 'sorting', 'comparison'];
        const QUESTION_TYPES_MULT_DIV = ['mult-div', 'find-x-mult-div', 'sorting', 'comparison'];
        const MAX_QUIZ_TIME_SECONDS = 30 * 60; // 30 ph√∫t

        // ƒê·ªãnh nghƒ©a c√°c b·∫£ng nh√¢n cho t·ª´ng c·∫•p ƒë·ªô Nh√¢n Chia
        const MULT_DIV_FACTORS = {
            1: [2, 3], // C·∫•p 1: x2, x3
            2: [4, 5], // C·∫•p 2: x4, x5
            3: [6, 7], // C·∫•p 3: x6, x7
            4: [8, 9]  // C·∫•p 4: x8, x9
        };

        // Kh·ªüi t·∫°o c√°c bi·∫øn tr·∫°ng th√°i
        let currentLevel = 1;
        let currentLevelName = 'C·∫•p 1 (Ph·∫°m vi 0-9)';
        let currentQuizType = 'ADD_SUB'; // Th√™m bi·∫øn theo d√µi lo·∫°i quiz ƒëang ch·ªçn
        let currentScore = 0;
        let currentQuestionNumber = 0; 
        let currentQuestion = null;
        let quizTimer = null; // Bi·∫øn cho setInterval
        let timeRemaining = MAX_QUIZ_TIME_SECONDS;
        let startTime = 0;

        // C√°c ph·∫ßn t·ª≠ DOM
        const setupScreen = document.getElementById('setup-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const endScreen = document.getElementById('end-screen');
        const levelSelectBtns = document.querySelectorAll('.level-select-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const exitQuizBtn = document.getElementById('exit-quiz-btn');
        const questionText = document.getElementById('question-text');
        const currentLevelNameSpan = document.getElementById('current-level-name');
        const currentQuestionNumberSpan = document.getElementById('current-question-number');
        const totalQuestionsSpan = document.getElementById('total-questions');
        const currentScoreSpan = document.getElementById('current-score');
        const finalScoreSpan = document.getElementById('final-score');
        const mathAnswerInput = document.getElementById('math-answer-input');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        const messageBox = document.getElementById('message-box');
        const inputAnswerContainer = document.getElementById('input-answer-container');
        const sortingNumbersContainer = document.getElementById('sorting-numbers-container');
        const sortingTargetContainer = document.getElementById('sorting-target-container');
        const sortingControls = document.getElementById('sorting-controls');
        const resetSortingBtn = document.getElementById('reset-sorting-btn');
        const submitSortingBtn = document.getElementById('submit-sorting-btn');
        const progressBar = document.getElementById('progress-bar');
        const scoreEffect = document.getElementById('score-effect');
        const quizTimerDisplay = document.getElementById('quiz-timer');
        const timeTakenMessage = document.getElementById('time-taken-message');
        const clockImageContainer = document.getElementById('clock-image-container');
        const levelDescription = document.getElementById('level-description');
	let TOTAL_QUIZ_QUESTIONS = 20; // M·∫∑c ƒë·ªãnh
	
	
        // Ph·∫ßn t·ª≠ m·ªõi cho So s√°nh
        const comparisonDisplayArea = document.getElementById('comparison-display-area');
        const expressionLeft = document.getElementById('expression-left');
        const expressionRight = document.getElementById('expression-right');
        const comparisonBox = document.getElementById('comparison-box');
        const comparisonButtonsContainer = document.getElementById('comparison-buttons-container');
        const comparisonButtons = document.querySelectorAll('.comp-btn');
        
        // Modal components
        const confirmModal = document.getElementById('confirm-modal');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');


        // --- Tone.js Setup for Sound Effects ---
        
        // Synth cho √¢m thanh ch√≠nh x√°c (correct)
        const correctSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sine" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.01, release: 0.5 },
        }).toDestination();

        // Synth cho √¢m thanh sai (incorrect)
        const incorrectSynth = new Tone.NoiseSynth({
            volume: -10,
            envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.2 }
        }).toDestination();

        // Bi·∫øn ki·ªÉm tra Audio Context
        let isAudioContextStarted = false;
        
        function startAudioContext() {
            if (!isAudioContextStarted) {
                Tone.start();
                isAudioContextStarted = true;
                console.log("Tone.js Audio Context started.");
            }
        }

        function playCorrectSound() {
            if (!isAudioContextStarted) return;
            correctSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n");
        }

        function playIncorrectSound() {
            if (!isAudioContextStarted) return;
            incorrectSynth.triggerAttackRelease("16n");
        }
        
        // --- Logic H·∫πn gi·ªù ---

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            quizTimerDisplay.textContent = formatTime(timeRemaining);
            if (timeRemaining <= 60) {
                quizTimerDisplay.classList.add('text-4xl');
                quizTimerDisplay.classList.remove('text-3xl');
            } else {
                quizTimerDisplay.classList.add('text-3xl');
                quizTimerDisplay.classList.remove('text-4xl');
            }
        }

        function startTimer() {
            startTime = Date.now();
            timeRemaining = MAX_QUIZ_TIME_SECONDS;
            updateTimerDisplay();
            
            if (quizTimer) clearInterval(quizTimer);

            quizTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(quizTimer);
                    endQuiz(true); // K·∫øt th√∫c do h·∫øt gi·ªù
                }
            }, 1000);
        }

        function stopTimer() {
            if (quizTimer) clearInterval(quizTimer);
            quizTimer = null;
        }

        // --- H√†m Ti·ªán √çch ---

        function getMaxRange(level) {
            if (level === 1) return 10;
            if (level === 2) return 100;
            if (level === 3) return 1000;
            return 10; // Fallback cho tr∆∞·ªùng h·ª£p kh√¥ng x√°c ƒë·ªãnh
        }

        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        // --- Logic Hi·ªáu ·ª©ng ƒêi·ªÉm ---

        function showScoreEffect(isCorrect) {
            scoreEffect.textContent = isCorrect ? '+1' : '0';
            scoreEffect.className = isCorrect
                ? 'score-effect text-yellow-500' 
                : 'score-effect text-red-500'; 

            scoreEffect.style.opacity = '0';
            scoreEffect.style.transform = 'translateY(0)';
            void scoreEffect.offsetWidth;

            scoreEffect.style.opacity = '1';
            scoreEffect.style.transform = 'translateY(-25px)';

            setTimeout(() => {
                scoreEffect.style.opacity = '0';
            }, 500);
        }

        // --- Logic T·∫°o C√¢u H·ªèi M·ªõi ---

        function generateBasicOpQuestion(max) {
            let A, B, op, answer, question;
            do {
                A = getRandomInt(max) + 1;
                B = getRandomInt(max) + 1;
                op = (Math.random() > 0.5) ? '+' : '-';
                if (op === '+') {
                    answer = A + B;
                    question = `${A} + ${B} = ?`;
                } else {
                    if (A < B) [A, B] = [B, A];
                    answer = A - B;
                    question = `${A} - ${B} = ?`;
                }
            } while (answer < 0 || answer >= max * 2);
            return { question, answer: String(answer), type: 'input' };
        }

        function generateMultDivQuestion() {
            // S·ª≠ d·ª•ng b·∫£ng c·ª≠u ch∆∞∆°ng theo c·∫•p ƒë·ªô
            const factors = MULT_DIV_FACTORS[currentLevel];
            const baseFactor = factors[getRandomInt(factors.length)]; // Nh√¢n t·ª≠ c∆° s·ªü (2, 3, 4,...)
            const otherFactor = getRandomInt(10) + 1; // S·ªë nh√¢n c√≤n l·∫°i (1 ƒë·∫øn 10)

            let A, B, op, answer, question;
            
            if (Math.random() > 0.5) { // Multiplication: A x B = ?
                A = baseFactor; 
                B = otherFactor;
                answer = A * B;
                question = `${A} √ó ${B} = ?`;
            } else { // Division: C √∑ B = ?
                // ƒê·∫£m b·∫£o ph√©p chia h·∫øt v√† n·∫±m trong ph·∫°m vi b·∫£ng c·ª≠u ch∆∞∆°ng
                B = baseFactor; // S·ªë chia (ph·∫£i l√† factor)
                answer = otherFactor; // Th∆∞∆°ng (t·ª´ 1 ƒë·∫øn 10)
                A = B * answer; // S·ªë b·ªã chia
                question = `${A} √∑ ${B} = ?`;
            }
            return { question, answer: String(answer), type: 'input' };
        }
        
        function generateFindXMultDivQuestion() {
            // S·ª≠ d·ª•ng b·∫£ng c·ª≠u ch∆∞∆°ng theo c·∫•p ƒë·ªô
            const factors = MULT_DIV_FACTORS[currentLevel];
            const baseFactor = factors[getRandomInt(factors.length)]; // Nh√¢n t·ª≠ c∆° s·ªü
            const otherFactor = getRandomInt(10) + 1; // S·ªë nh√¢n c√≤n l·∫°i (1 ƒë·∫øn 10)
            
            let A, B, answer, question;
            
            if (Math.random() < 0.5) { // Multiplication: A x ? = C ho·∫∑c ? x B = C
                B = baseFactor;
                answer = otherFactor;
                A = B * answer; // Product
                
                if (Math.random() > 0.5) {
                     question = `${B} √ó ? = ${A}`; // T√¨m nh√¢n t·ª≠ (otherFactor)
                } else {
                     question = `? √ó ${B} = ${A}`; // T√¨m nh√¢n t·ª≠ (otherFactor)
                }
            } else { // Division: A √∑ ? = C ho·∫∑c ? √∑ B = C ho·∫∑c A √∑ B = ?
                B = baseFactor; // S·ªë chia
                answer = otherFactor; // Th∆∞∆°ng
                A = B * answer; // S·ªë b·ªã chia
                
                // Randomly choose the unknown part
                const unknownType = getRandomInt(3); 
                
                if (unknownType === 0) { // T√¨m s·ªë b·ªã chia (A)
                    question = `? √∑ ${B} = ${answer}`;
                } else if (unknownType === 1) { // T√¨m s·ªë chia (B)
                    answer = B; // S·ªë chia l√† ƒë√°p √°n
                    question = `${A} √∑ ? = ${otherFactor}`; // Th∆∞∆°ng l√† otherFactor
                } else { // T√¨m th∆∞∆°ng (answer)
                    question = `${A} √∑ ${B} = ?`;
                    // Answer is already correct (otherFactor)
                }
            }
            return { question, answer: String(answer), type: 'input' };
        }

        function generateFindXQuestion(max) {
            let A, B, op, answer, question;
            do {
                A = getRandomInt(max) + 1;
                op = (Math.random() > 0.5) ? '+' : '-';
                if (op === '+') {
                    answer = getRandomInt(max) + 1;
                    const C = A + answer;
                    question = `${A} + ? = ${C}`;
                } else {
                    if (Math.random() > 0.5) {
                        const C = getRandomInt(A);
                        answer = A - C;
                        question = `${A} - ? = ${C}`;
                    } else {
                        B = getRandomInt(max) + 1;
                        const C = getRandomInt(max) + 1;
                        answer = B + C;
                        question = `? - ${B} = ${C}`;
                    }
                }
            } while (answer <= 0 || answer >= max * 2);
            return { question, answer: String(answer), type: 'input' };
        }

        function generateSortingQuestion(level) {
            // ƒê·∫£m b·∫£o lu√¥n l√† 5 s·ªë
            const count = 5; 
            
            let max;
            if (level === 1) max = 100; // 0-100
            else if (level === 2) max = 500; // 0-500
            else max = 1000; // 0-1000 cho c·∫•p 3 v√† c·∫•p 4 (d√πng max range cao nh·∫•t)

            const direction = (Math.random() > 0.5) ? 'tƒÉng d·∫ßn' : 'gi·∫£m d·∫ßn';
            const numbers = [];
            while (numbers.length < count) {
                const num = getRandomInt(max) + 1;
                if (!numbers.includes(num)) {
                    numbers.push(num);
                }
            }
            let sorted = [...numbers].sort((a, b) => a - b);
            if (direction === 'gi·∫£m d·∫ßn') {
                sorted.reverse();
            }
            const answer = sorted.join(',');
            
            const directionColorClass = (direction === 'tƒÉng d·∫ßn') ? 'text-blue-600' : 'text-red-600';
            
            const question = `S·∫Øp x·∫øp c√°c s·ªë sau theo th·ª© t·ª± <span class="font-extrabold ${directionColorClass}">${direction}</span>:`;
            return { question, numbers, answer, direction, type: 'sorting' };
        }

        // H√†m t·∫°o m·ªôt ph√©p t√≠nh ƒë∆°n gi·∫£n d·ª±a tr√™n lo·∫°i quiz v√† c·∫•p ƒë·ªô
        function generateSimpleExpression(max, quizType) {
            let A, B, op, result;
            
            if (quizType === 'MULT_DIV') {
                const factors = MULT_DIV_FACTORS[currentLevel];
                let A_factor = factors[getRandomInt(factors.length)]; // Nh√¢n t·ª≠ c∆° s·ªü
                let B_factor = getRandomInt(10) + 1; // Nh√¢n t·ª≠ c√≤n l·∫°i (1 ƒë·∫øn 10)

                op = (Math.random() > 0.5) ? '√ó' : '√∑';

                if (op === '√ó') {
                    A = A_factor;
                    B = B_factor;
                    result = A * B;
                } else {
                    // Division (A √∑ B = result)
                    const Divisor = A_factor;
                    const Quotient = B_factor;
                    const Dividend = Divisor * Quotient;
                    
                    // Randomly choose form: Dividend √∑ Divisor = ? or Dividend √∑ Quotient = ?
                    if (Math.random() > 0.5) { 
                        A = Dividend;
                        B = Divisor;
                        result = Quotient;
                    } else {
                        A = Dividend;
                        B = Quotient;
                        result = Divisor;
                    }
                }
            } else { // ADD_SUB
                A = getRandomInt(max) + 1;
                B = getRandomInt(max) + 1;
                op = (Math.random() > 0.5) ? '+' : '-';
                
                if (op === '-') {
                    if (A < B) [A, B] = [B, A];
                }
                
                result = (op === '+') ? A + B : A - B;
            }
            // Thay th·∫ø '√ó' v√† '√∑' b·∫±ng '*' v√† '/' ƒë·ªÉ eval() c√≥ th·ªÉ t√≠nh
            const expression = `${A} ${op} ${B}`; 
            return { expression: expression.replace('√ó', '*').replace('√∑', '/'), result: result };
        }

        function generateComparisonQuestion(level) {
            const isMultDivLevel = (currentQuizType === 'MULT_DIV');
            // Max range cho ADD_SUB trong comparison, MULT_DIV s·∫Ω d√πng factors
            const max = isMultDivLevel ? 10 : (level === 1) ? 15 : (level === 2) ? 100 : 500;
            
            let exp1 = generateSimpleExpression(max, currentQuizType);
            let exp2 = generateSimpleExpression(max, currentQuizType);
            
            // ƒê·∫£m b·∫£o k·∫øt qu·∫£ kh√¥ng qu√° ch√™nh l·ªách (ch·ªâ √°p d·ª•ng cho C·ªông/Tr·ª´)
            if (!isMultDivLevel && Math.abs(exp1.result - exp2.result) > 20 && exp1.result !== exp2.result) {
                 exp2 = generateSimpleExpression(max, currentQuizType);
            }
            
            let answer = '';
            // D√πng eval ƒë·ªÉ so s√°nh ch√≠nh x√°c k·∫øt qu·∫£
            const val1 = eval(exp1.expression);
            const val2 = eval(exp2.expression);
            
            if (val1 > val2) answer = '>';
            else if (val1 < val2) answer = '<';
            else answer = '=';

            return { 
                question: 'Ch·ªçn d·∫•u so s√°nh ƒë√∫ng:', 
                exp1: exp1.expression.replace('*', '√ó').replace('/', '√∑'), // Hi·ªÉn th·ªã k√Ω hi·ªáu to√°n h·ªçc
                exp2: exp2.expression.replace('*', '√ó').replace('/', '√∑'), // Hi·ªÉn th·ªã k√Ω hi·ªáu to√°n h·ªçc
                answer: answer, 
                result1: val1, // Th√™m k·∫øt qu·∫£ c·ªßa v·∫ø 1
                result2: val2, // Th√™m k·∫øt qu·∫£ c·ªßa v·∫ø 2
                type: 'comparison' 
            };
        }
        
        // H√†m t·∫°o SVG ƒë·ªìng h·ªì kim
        function createClockSVG(hour, minute) {
            const size = 150;
            const centerX = size / 2;
            const centerY = size / 2;
            const hourAngle = (hour % 12 + minute / 60) * 30 - 90;
            const minuteAngle = minute * 6 - 90;

            let svgHtml = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
            // V√≤ng tr√≤n ngo√†i
            svgHtml += `<circle cx="${centerX}" cy="${centerY}" r="70" class="clock-face"/>`;
            // V·∫°ch gi·ªù
            for (let i = 1; i <= 12; i++) {
                const angle = i * 30 * Math.PI / 180;
                const r = 60;
                const x = centerX + r * Math.cos(angle - Math.PI / 2);
                const y = centerY + r * Math.sin(angle - Math.PI / 2);
                svgHtml += `<text x="${x}" y="${y + 5}" text-anchor="middle" font-size="12" fill="#374151">${i}</text>`;
            }
            // Kim gi·ªù
            svgHtml += `<line x1="${centerX}" y1="${centerY}" x2="${centerX + 40 * Math.cos(hourAngle * Math.PI / 180)}" y2="${centerY + 40 * Math.sin(hourAngle * Math.PI / 180)}" class="hour-hand"/>`;
            // Kim ph√∫t
            svgHtml += `<line x1="${centerX}" y1="${centerY}" x2="${centerX + 60 * Math.cos(minuteAngle * Math.PI / 180)}" y2="${centerY + 60 * Math.sin(minuteAngle * Math.PI / 180)}" class="minute-hand"/>`;
            // Ch·ªët gi·ªØa
            svgHtml += `<circle cx="${centerX}" cy="${centerY}" r="3" fill="#ef4444"/>`;
            svgHtml += `</svg>`;
            return svgHtml;
        }

        function generateClockQuestion() {
            // Ch·ªâ t·∫°o gi·ªù ch·∫µn (v√≠ d·ª•: 1:00, 1:30, 2:00, 2:30)
            const randomHour = getRandomInt(12) + 1; // 1 ƒë·∫øn 12
            const randomMinute = getRandomInt(2) * 30; // 0 ho·∫∑c 30

            // ƒê·ªãnh d·∫°ng HH:MM cho ƒë√°p √°n
            const hour = String(randomHour).padStart(2, '0');
            const minute = String(randomMinute).padStart(2, '0');
            const answer = `${hour}:${minute}`;

            // T·∫°o v√† hi·ªÉn th·ªã ƒë·ªìng h·ªì SVG
            const svgHtml = createClockSVG(randomHour, randomMinute);
            clockImageContainer.innerHTML = svgHtml;

            const question = `ƒê·ªìng h·ªì n√†y ƒëang ch·ªâ m·∫•y gi·ªù? (Nh·∫≠p d∆∞·ªõi d·∫°ng HH:MM)`;
            return { question, answer: answer, type: 'input', special: 'clock' };
        }

        function generateWordProblem() {
            const ops = ['+', '-'];
            const op = ops[getRandomInt(ops.length)];
            const max = 50; // Gi·ªõi h·∫°n b√†i to√°n l·ªùi vƒÉn 
            
            let A = getRandomInt(max) + 5;
            let B = getRandomInt(A / 2) + 2; // ƒê·∫£m b·∫£o s·ªë h·ª£p l√Ω

            let problemText;
            let answer;

            if (op === '+') {
                answer = A + B;
                problemText = `B·∫°n An c√≥ ${A} vi√™n k·∫πo. M·∫π cho An th√™m ${B} vi√™n k·∫πo n·ªØa. H·ªèi b·∫°n An c√≥ t·∫•t c·∫£ bao nhi√™u vi√™n k·∫πo?`;
            } else {
                answer = A - B;
                problemText = `B·∫°n B√¨nh c√≥ ${A} qu·∫£ t√°o. B√¨nh cho b·∫°n ${B} qu·∫£. H·ªèi B√¨nh c√≤n l·∫°i bao nhi√™u qu·∫£ t√°o?`;
            }
            
            const question = `**B√†i to√°n c√≥ l·ªùi vƒÉn:** ${problemText}`;
            return { question, answer: String(answer), type: 'input', special: 'word-problem' };
        }

        /**
         * H√†m ch√≠nh ƒë·ªÉ t·∫°o c√¢u h·ªèi ng·∫´u nhi√™n v√† ki·ªÉm tra k·∫øt th√∫c
         */
        function generateQuestion() {
            if (currentQuestionNumber >= TOTAL_QUIZ_QUESTIONS) {
                endQuiz(false); // K·∫øt th√∫c do ho√†n th√†nh
                return;
            }

            currentQuestionNumber++;
            currentQuestionNumberSpan.textContent = currentQuestionNumber;
            
            // C·∫≠p nh·∫≠t Progress Bar
            const percentage = (currentQuestionNumber / TOTAL_QUIZ_QUESTIONS) * 100;
            progressBar.style.width = `${percentage}%`;

            let randomType;
            let maxRange = getMaxRange(currentLevel);
            let questionPool;

            if (currentQuizType === 'MULT_DIV') {
                 // C·∫•p Nh√¢n/Chia: Nh√¢n/Chia, T√¨m X (Nh√¢n/Chia), So s√°nh (Nh√¢n/Chia), S·∫Øp x·∫øp
                 questionPool = QUESTION_TYPES_MULT_DIV;
            } else {
                // C·∫•p C·ªông/Tr·ª´: C·ªông/Tr·ª´, T√¨m X (C·ªông/Tr·ª´), So s√°nh (C·ªông/Tr·ª´), S·∫Øp x·∫øp
                questionPool = QUESTION_TYPES_BASIC;
            }


            // X·ª≠ l√Ω 2 c√¢u h·ªèi ƒë·∫∑c bi·ªát cu·ªëi c√πng
            if (currentQuestionNumber === 19) {
                currentQuestion = generateClockQuestion();
            } else if (currentQuestionNumber === 20) {
                currentQuestion = generateWordProblem();
            } else {
                // T·∫°o c√¢u h·ªèi ng·∫´u nhi√™n
                randomType = questionPool[getRandomInt(questionPool.length)];

                switch (randomType) {
                    case 'basic-op':
                        currentQuestion = generateBasicOpQuestion(maxRange);
                        break;
                    case 'mult-div':
                        currentQuestion = generateMultDivQuestion();
                        break;
                    case 'find-x':
                        currentQuestion = generateFindXQuestion(maxRange);
                        break;
                    case 'find-x-mult-div':
                        currentQuestion = generateFindXMultDivQuestion();
                        break;
                    case 'sorting':
                        currentQuestion = generateSortingQuestion(currentLevel);
                        break;
                    case 'comparison':
                        currentQuestion = generateComparisonQuestion(currentLevel);
                        break;
                    default:
                        // Default fallback
                        currentQuestion = generateBasicOpQuestion(10); 
                }
            }

            displayQuestion(currentQuestion);
        }

        // --- Logic Hi·ªÉn Th·ªã C√¢u H·ªèi v√† ƒê√°p √Ån ---

        function displayQuestion(q) {
            messageBox.textContent = '';
            nextQuestionBtn.classList.add('hidden');
            
            // ·∫®n t·∫•t c·∫£ c√°c khu v·ª±c tr·∫£ l·ªùi v√† hi·ªÉn th·ªã
            inputAnswerContainer.classList.add('hidden');
            sortingNumbersContainer.classList.add('hidden');
            sortingTargetContainer.classList.add('hidden');
            sortingControls.classList.add('hidden');
            comparisonButtonsContainer.classList.add('hidden');
            clockImageContainer.classList.add('hidden'); 
            comparisonDisplayArea.classList.add('hidden');
            questionText.classList.remove('hidden'); // Hi·ªÉn th·ªã text m·∫∑c ƒë·ªãnh

            if (q.type === 'input') {
                // Hi·ªÉn th·ªã d·∫°ng nh·∫≠p ƒë√°p √°n
                questionText.innerHTML = q.question;
                inputAnswerContainer.classList.remove('hidden');
                mathAnswerInput.value = '';
                mathAnswerInput.focus();
                submitAnswerBtn.onclick = checkMathAnswer;
                submitAnswerBtn.disabled = false;
                
                if (q.special === 'clock') {
                    clockImageContainer.classList.remove('hidden');
                }
            } else if (q.type === 'sorting') {
                // Hi·ªÉn th·ªã d·∫°ng s·∫Øp x·∫øp
                questionText.innerHTML = q.question;
                sortingNumbersContainer.classList.remove('hidden');
                sortingTargetContainer.classList.remove('hidden');
                sortingControls.classList.remove('hidden');
                renderSortingNumbers(q.numbers);
                sortingTargetContainer.innerHTML = '';
                submitSortingBtn.onclick = checkSortingAnswer;
                submitSortingBtn.disabled = false;
                resetSortingBtn.disabled = false;
            } else if (q.type === 'comparison') {
                // Hi·ªÉn th·ªã d·∫°ng so s√°nh 2 ph√©p t√≠nh
                questionText.innerHTML = q.question;
                questionText.classList.add('hidden'); // ·∫®n text m·∫∑c ƒë·ªãnh
                
                comparisonDisplayArea.classList.remove('hidden');
                comparisonButtonsContainer.classList.remove('hidden');
                
                expressionLeft.textContent = q.exp1;
                expressionRight.textContent = q.exp2;
                comparisonBox.textContent = '?';
                comparisonBox.classList.remove('correct-answer-box', 'incorrect-answer-box');
                comparisonButtons.forEach(btn => btn.disabled = false);
            }
        }

        function renderSortingNumbers(numbers) {
            sortingNumbersContainer.innerHTML = '';
            numbers.forEach(num => {
                const numDiv = document.createElement('div');
                numDiv.className = 'sorting-number px-4 py-2 bg-white border border-gray-300 rounded-lg text-2xl font-semibold text-gray-800 shadow-sm';
                numDiv.textContent = num;
                numDiv.setAttribute('data-value', num);
                numDiv.addEventListener('click', () => handleNumberClick(numDiv));
                sortingNumbersContainer.appendChild(numDiv);
            });
        }

        function handleNumberClick(element) {
            if (submitSortingBtn.disabled) return; 

            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                // Chuy·ªÉn v·ªÅ container s·ªë g·ªëc
                sortingNumbersContainer.appendChild(element);
            } else {
                element.classList.add('selected');
                // Chuy·ªÉn sang container ƒë√≠ch
                sortingTargetContainer.appendChild(element);
            }
        }

        // --- Logic Ki·ªÉm tra ƒê√°p √°n ---

        function processAnswerResult(isCorrect, correctAnswerText) {
            if (isCorrect) {
                currentScore++;
                // C·∫≠p nh·∫≠t message box d·ª±a tr√™n lo·∫°i c√¢u h·ªèi
                if (currentQuestion.type === 'input') {
                     messageBox.innerHTML = `üéâ <span class="text-green-800">Ch√≠nh x√°c!</span> ƒê√°p √°n l√†: <span class="text-green-600 font-extrabold">${correctAnswerText}</span>`;
                } else if (currentQuestion.type === 'comparison') {
                    // ƒê·ªëi v·ªõi so s√°nh, correctAnswerText ƒë√£ l√† th√¥ng ƒëi·ªáp ƒë·∫ßy ƒë·ªß c√≥ k·∫øt qu·∫£
                    messageBox.innerHTML = `üéâ <span class="text-green-800">Ch√≠nh x√°c!</span> ${correctAnswerText}`;
                    comparisonBox.classList.add('correct-answer-box');
                } else { // sorting
                     messageBox.innerHTML = `üéâ <span class="text-green-800">Ch√≠nh x√°c!</span> Th·ª© t·ª± ƒë√∫ng l√†: ${correctAnswerText}`;
                }
                
                messageBox.className = 'mt-4 text-xl font-bold text-green-800 p-3 rounded-lg correct-answer-box min-h-[30px]'; 
                showScoreEffect(true);
                playCorrectSound();
            } else {
                if (currentQuestion.type === 'comparison') {
                    // ƒê·ªëi v·ªõi so s√°nh, correctAnswerText ƒë√£ l√† th√¥ng ƒëi·ªáp ƒë·∫ßy ƒë·ªß c√≥ k·∫øt qu·∫£
                    messageBox.innerHTML = `‚ùå <span class="text-red-800">Sai r·ªìi!</span> ${correctAnswerText}`;
                } else {
                    messageBox.innerHTML = `‚ùå <span class="text-red-800">Sai r·ªìi!</span> ƒê√°p √°n ƒë√∫ng l√†: <span class="text-red-600 font-extrabold">${correctAnswerText}</span>`;
                }
                
                messageBox.className = 'mt-4 text-xl font-bold text-red-800 p-3 rounded-lg incorrect-answer-box min-h-[30px]';
                showScoreEffect(false);
                playIncorrectSound();

                if (currentQuestion.type === 'comparison') {
                    comparisonBox.classList.add('incorrect-answer-box');
                }
            }
            currentScoreSpan.textContent = currentScore;
            nextQuestionBtn.classList.remove('hidden');
        }

        function checkMathAnswer() {
            const userAnswer = mathAnswerInput.value.trim();
            const correctAnswer = currentQuestion.answer;
            
            if (userAnswer === '') {
                messageBox.textContent = 'Vui l√≤ng nh·∫≠p ƒë√°p √°n!';
                messageBox.className = 'mt-4 text-xl font-bold text-yellow-800 p-3 rounded-lg warning-answer-box min-h-[30px]'; 
                return;
            }

            submitAnswerBtn.disabled = true;
            processAnswerResult(userAnswer === correctAnswer, correctAnswer);
        }

        function checkSortingAnswer() {
            const selectedElements = Array.from(sortingTargetContainer.children);
            const userAnswerArray = selectedElements.map(el => el.getAttribute('data-value')).join(',');
            const correctAnswer = currentQuestion.answer;
            const isCorrect = (userAnswerArray === correctAnswer);

            submitSortingBtn.disabled = true;
            resetSortingBtn.disabled = true;

            // Lo·∫°i b·ªè ** v√† th√™m span cho m√†u s·∫Øc n·ªïi b·∫≠t
            const correctAnswerText = correctAnswer.split(',').join(' <span class="text-indigo-600 font-extrabold">‚Üí</span> ');
            
            if (isCorrect) {
                selectedElements.forEach(el => {
                    el.classList.remove('selected');
                    el.classList.add('bg-green-200', 'text-green-800'); 
                    el.removeEventListener('click', handleNumberClick);
                });
            } else {
                const userText = userAnswerArray.split(',').join(' ‚Üí ');
                // C·∫≠p nh·∫≠t messageBox ƒë·ªÉ hi·ªÉn th·ªã c·∫£ ƒë√°p √°n ng∆∞·ªùi d√πng v√† ƒë√°p √°n ƒë√∫ng
                const fullMessage = `Th·ª© t·ª± b·∫°n ch·ªçn l√†: ${userText}. ƒê√∫ng ph·∫£i l√†: ${correctAnswerText}`;
                processAnswerResult(false, fullMessage);
                return; 
            }

            processAnswerResult(isCorrect, correctAnswerText);
        }

        function checkComparisonAnswer(userOp) {
            comparisonButtons.forEach(btn => btn.disabled = true);
            const isCorrect = (userOp === currentQuestion.answer);
            
            // X√¢y d·ª±ng th√¥ng ƒëi·ªáp hi·ªÉn th·ªã k·∫øt qu·∫£ chi ti·∫øt
            // Lo·∫°i b·ªè ** v√† th√™m span v·ªõi m√†u xanh/ƒë·ªè cho n·ªïi b·∫≠t
            const resultMsg = `(${currentQuestion.exp1} = <span class="text-indigo-600 font-extrabold">${currentQuestion.result1}</span>) ${currentQuestion.answer} (${currentQuestion.exp2} = <span class="text-indigo-600 font-extrabold">${currentQuestion.result2}</span>).`;

            // Hi·ªÉn th·ªã d·∫•u so s√°nh ƒë√£ ch·ªçn trong √¥
            comparisonBox.textContent = userOp;

            processAnswerResult(isCorrect, resultMsg);
        }


        // --- Logic K·∫øt th√∫c Quiz ---

        function endQuiz(isTimeout) {
            stopTimer();
            quizScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            finalScoreSpan.textContent = currentScore;
            
            if (isTimeout) {
                timeTakenMessage.textContent = 'H·∫øt gi·ªù! Quiz ƒë√£ k·∫øt th√∫c.';
            } else {
                const totalSeconds = MAX_QUIZ_TIME_SECONDS - timeRemaining;
                const timeStr = formatTime(totalSeconds);
                timeTakenMessage.textContent = `B·∫°n ƒë√£ ho√†n th√†nh trong ${timeStr}.`;
            }
        }
        
        // --- Logic Modal ---
        function showModal() {
            stopTimer();
            confirmModal.classList.remove('hidden');
        }

        function hideModal() {
            confirmModal.classList.add('hidden');
            if (quizScreen.classList.contains('hidden') === false) {
                 startTimer(); // Ti·∫øp t·ª•c ƒë·∫øm gi·ªù n·∫øu ng∆∞·ªùi d√πng h·ªßy tho√°t
            }
        }

        function exitToSetupScreen() {
            stopTimer();
            hideModal();
            quizScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            // ƒê·∫∑t l·∫°i tr·∫°ng th√°i m√†n h√¨nh c√†i ƒë·∫∑t
            // Ch·ªçn m·∫∑c ƒë·ªãnh C·∫•p 1 C·ªông Tr·ª´
            levelSelectBtns[0].click();
        }

        // --- X·ª≠ l√Ω S·ª± ki·ªán Giao di·ªán ---

        levelSelectBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentLevel = parseInt(btn.getAttribute('data-level'));
                currentLevelName = btn.getAttribute('data-name');
                currentQuizType = btn.getAttribute('data-type'); // L·∫•y lo·∫°i quiz


                levelSelectBtns.forEach(b => {
                    // X√≥a m√†u n·ªÅn xanh (ADD_SUB) v√† xanh l√° (MULT_DIV) c≈©
                    b.classList.remove('bg-indigo-500', 'text-white', 'bg-green-500');
                    // Th√™m m√†u n·ªÅn x√°m m·∫∑c ƒë·ªãnh
                    b.classList.add('bg-gray-200', 'text-gray-700');
                });
                
                // Thi·∫øt l·∫≠p m√†u m·ªõi d·ª±a tr√™n lo·∫°i quiz
                if (currentQuizType === 'ADD_SUB') {
                    btn.classList.add('bg-indigo-500', 'text-white');
                } else {
                    btn.classList.add('bg-green-500', 'text-white');
                }
                btn.classList.remove('bg-gray-200', 'text-gray-700');
                startQuizBtn.disabled = false;
                levelDescription.textContent = `B·∫°n ƒë√£ ch·ªçn: ${currentLevelName}`;
            });
        });
        
        startQuizBtn.addEventListener('click', () => {
            startAudioContext(); 
            if (!currentLevel) { return; }

            currentScore = 0;
            currentQuestionNumber = 0;
            currentScoreSpan.textContent = 0;
            totalQuestionsSpan.textContent = TOTAL_QUIZ_QUESTIONS;
            currentLevelNameSpan.textContent = currentLevelName;

            setupScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            
            startTimer(); // B·∫Øt ƒë·∫ßu ƒë·∫øm gi·ªù
            generateQuestion();
        });

        restartQuizBtn.addEventListener('click', () => {
            // Chuy·ªÉn v·ªÅ m√†n h√¨nh ch√≠nh (Setup)
            exitToSetupScreen();
        });

        nextQuestionBtn.addEventListener('click', () => {
            generateQuestion();
        });

        mathAnswerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !submitAnswerBtn.disabled) {
                checkMathAnswer();
            } else if (e.key === 'Enter' && nextQuestionBtn.classList.contains('hidden') === false) {
                 nextQuestionBtn.click();
            }
        });
        
        comparisonButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                checkComparisonAnswer(btn.getAttribute('data-op'));
            });
        });

        resetSortingBtn.addEventListener('click', () => {
            Array.from(sortingTargetContainer.children).forEach(el => {
                el.classList.remove('selected');
                sortingNumbersContainer.appendChild(el);
            });
        });

        // N√∫t Quay l·∫°i M√†n h√¨nh Ch√≠nh
        exitQuizBtn.addEventListener('click', showModal);
        modalCancelBtn.addEventListener('click', hideModal);
        modalConfirmBtn.addEventListener('click', exitToSetupScreen);


        // Thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu khi t·∫£i trang
        document.addEventListener('DOMContentLoaded', () => {
            // Ch·ªçn m·∫∑c ƒë·ªãnh C·∫•p 1 C·ªông Tr·ª´
            levelSelectBtns[0].click();
            startQuizBtn.disabled = false;
	const questionCountBtns = document.querySelectorAll('.q-count-btn');

    	questionCountBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            TOTAL_QUIZ_QUESTIONS = parseInt(btn.getAttribute('data-questions'));

            questionCountBtns.forEach(b => {
                b.classList.remove('bg-indigo-500', 'text-white');
                b.classList.add('bg-gray-200', 'text-gray-700');
            });

            btn.classList.add('bg-indigo-500', 'text-white');
            btn.classList.remove('bg-gray-200', 'text-gray-700');
        });
	});
});
    </script>
</body>
</html>